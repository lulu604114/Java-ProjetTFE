<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="../../WEB-INF/template/template.xhtml">

    <ui:define name="title">Empty Page</ui:define>

    <ui:define name="content">
        <div class="ui-g">
            <div class="ui-g-12">
                <p:panel>
                    <f:facet name="header">
                        <div class="toolbar">
                            <div class="text">
                                <h1>Dépense</h1>
                                <small class="tag">Fournisseur : #{chargeDetailView.charge.userSupplier.supplier.label}</small>
                                <small class="tag">Facturé le  :
                                    <h:outputText value="#{chargeDetailView.charge.createdAt}">
                                        <f:convertDateTime pattern="dd/MM/yyyy"/>
                                    </h:outputText>
                                </small>
                                <small class="tag #{chargeDetailView.charge.status.statusClass}" style="margin-left: 3px">Statut du paiement : #{cmp[chargeDetailView.charge.status.status]}</small>
                            </div>
                            <div class="button">
                                <p:linkButton icon="fas fa-arrow-left" styleClass="primary-button" outcome="/app/charge/chargeList" />
                                <span class="ui-separator" style="margin-left: 10px">
                            <span class="fa fa-ellipsis-v SoftGray" />
                        </span>

                                <p:commandButton icon="fas fa-wrench" styleClass="warning-btn"/>
                                <p:commandButton icon="far fa-trash-alt" styleClass="danger-btn"/>
                            </div>
                        </div>

                    </f:facet>

                    <div class="toolbar">
                        <div class="text">
                            <h4> <i class="far fa-clock"></i>   Marquez votre facture comme payée le cas échéant.</h4>
                            <small>Vous pouvez uploader une pièce justificative, encoder les imputations et leurs éventuels amortissements.</small>
                        </div>
                        <div class="button">
                            <p:commandButton icon="fas fa-redo" styleClass="help-btn"/>
                            <p:commandButton icon="fas fa-plus-circle" styleClass="secondary-button"/>
                            <p:commandButton icon="fas fa-cloud-upload-alt" styleClass="info-btn"/>
                            <p:commandButton icon="fas fa-euro-sign" value="Marquer comme payée" styleClass="success-btn"/>
                        </div>
                    </div>
                </p:panel>
            </div>
        </div>

        <h:form id="chargeDetailForm">
            <p:growl id="msgs" showDetail="true"/>

            <div class="ui-g">

                <!-- INFO CARD -->
                <div class="ui-g-12 ui-md-12 ui-lg-4">
                    <p:panel id="supplier-card">
                        <f:facet name="header">
                            <i class="fas fa-user"/>
                            <text/>
                            <h:outputText value="Fournisseur"/>
                        </f:facet>
                        <f:facet name="actions">
                            <p:commandLink id="supplier-card-edit-btn" type="button" onclick="PF('info-modal').show();" ajax="true"
                                           update="">
                                <i class="fa fa-fw fa-pencil"></i>
                            </p:commandLink>
                            <p:tooltip for="supplier-card-edit-btn" value="Editer" position="top"/>
                        </f:facet>
                        <div class="panel-content">
                            <ul>
                                <li>
                                    <div><i class="far fa-building"></i></div>
                                    <div class="panel-content-info">
                                        <small>Nom :</small>
                                        <div>#{chargeDetailView.charge.userSupplier.supplier.label}</div>
                                    </div>
                                </li>
                                <li>
                                    <div><i class="fas fa-id-card-alt"></i></div>
                                    <div class="panel-content-info">
                                        <small>N° de TVA : </small>
                                        <div>
                                            #{empty(chargeDetailView.charge.userSupplier.supplier.tva) ? '---' : chargeDetailView.charge.userSupplier.supplier.tva}
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div><i class="fas fa-money-check"></i></div>
                                    <div class="panel-content-info">
                                        <small>IBAN</small>
                                        <div>
                                            #{empty(chargeDetailView.charge.userSupplier.supplier.iban) ? '---' : chargeDetailView.charge.userSupplier.supplier.iban}
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </p:panel>
                </div>

                <!-- CONFIG CARD -->
                <div class="ui-g-12 ui-md-12 ui-lg-4">
                    <p:panel id="config-card">
                        <f:facet name="header">
                            <i class="fas fa-cogs"></i>
                            <text/>
                            <h:outputText value="Configuration"/>
                        </f:facet>
                        <f:facet name="actions">
                            <p:commandLink id="config-card-edit-btn" type="button" onclick="PF('chargeEdit-modal').show();" ajax="true"
                                           update="chargeEdit-modal-form">
                                <i class="fa fa-fw fa-pencil"></i>
                            </p:commandLink>
                            <p:tooltip for="config-card-edit-btn" value="Editer" position="top"/>
                        </f:facet>
                        <div class="panel-content">
                            <ul>
                                <li>
                                    <i class="fas fa-book"></i>
                                    <div class="panel-content-info">
                                        <small>Journal : </small>
                                        <div>
                                            <h:outputText value="#{chargeDetailView.charge.diary.label}"/>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div><i class="far fa-calendar-alt"></i></div>
                                    <div class="panel-content-info">
                                        <small>Année comptable : </small>
                                        <div>
                                            <h:outputText value="#{chargeDetailView.charge.financialYear.beginAt}"/>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div><i class="far fa-calendar-check"></i></div>
                                    <div class="panel-content-info">
                                        <small>Date de la facture : </small>
                                        <div>
                                            <h:outputText value="#{chargeDetailView.charge.createdAt}">
                                                <f:convertDateTime pattern="dd/MM/yyyy"/>
                                            </h:outputText>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div><i class="far fa-calendar-times"></i></div>
                                    <div class="panel-content-info">
                                        <small>Date limite de paiement : </small>
                                        <div>
                                            <h:outputText value="#{chargeDetailView.charge.dueAt}">
                                                <f:convertDateTime pattern="dd/MM/yyyy"/>
                                            </h:outputText>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </p:panel>
                </div>

                <!-- DETAIL CARD -->
                <div class="ui-g-12 ui-md-12 ui-lg-4">
                    <p:panel id="detail-card">
                        <f:facet name="header">
                            <i class="far fa-list-alt"></i>
                            <text/>
                            <h:outputText value="Détails"/>
                        </f:facet>
                        <f:facet name="actions">
                            <p:commandLink id="detail-card-edit-btn" type="button" onclick="PF('chargeEdit-modal').show();" ajax="true"
                                           update="chargeEdit-modal-form">
                                <i class="fa fa-fw fa-pencil"></i>
                            </p:commandLink>
                        </f:facet>
                        <div class="panel-content">
                            <ul>
                                <li>
                                    <div><i class="fa fa-fw fa-user"/></div>
                                    <div class="panel-content-info">
                                        <small>Montant de la facture : </small>
                                        <div>
                                            <h:outputText value="#{chargeDetailView.charge.amount}">
                                                <f:convertNumber type="currency" currencySymbol="€" maxFractionDigits="2"/>
                                            </h:outputText>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </p:panel>
                </div>
            </div>

            <div class="ui-g">
                <div class="ui-g-12">
                    <p:panel id="AccountItem-card">
                        <f:facet name="header">
                            <i class="fas fa-file-invoice"></i>
                            <text/>
                            <h:outputText value="Imputations"/>
                        </f:facet>
                        <f:facet name="actions">
                            <p:commandLink id="item-creation-btn"  ajax="true" onclick="PF('itemEdit-modal').show()"
                                           actionListener="#{chargeDetailView.newItem}" update="itemEdit-modal-form">
                                <i class="far fa-plus-square"/>
                            </p:commandLink>
                            <p:tooltip for="item-creation-btn" position="left" value="Ajouter une imputation"/>
                        </f:facet>
                        <p:dataTable id="itemList" var="item" value="#{chargeDetailView.charge.accountItems}">
                            <f:facet name="emptyMessage">
                                <div class="card emptyMessage">
                                    <i class="far fa-plus-square fa-5x icon-primary"/>
                                    <div class="text">
                                        <p>Ajouter des imputations à votre dépense afin de renseigner
                                            les différents éléments de votre facture et d'en définir
                                            leur % de déductibilité et leur éventuelle période d'amortissement.</p>
                                        <p:commandButton id="second-item-creation-btn" value="Ajouter une imputation" icon="fas fa-plus" styleClass="secondary-button"
                                                         ajax="true" onclick="PF('itemEdit-modal').show()" actionListener="#{chargeDetailView.newItem}" update="itemEdit-modal-form"/>
                                    </div>
                                </div>
                            </f:facet>
                            <p:column>
                                <f:facet name="header">Année</f:facet>
                                <h:outputText value="#{item.financialYear.beginAt}"/>
                            </p:column>
                            <p:column colspan="3">
                                <f:facet name="header">Charge</f:facet>
                                <h:outputText value="#{item.userAccount.financialAccount.label}"/>
                                <small style="display: block">
                                    <h:outputText value="#{item.description}"/>
                                </small>
                            </p:column>
                            <p:column>
                                <f:facet name="header">Montant</f:facet>
                                <h:outputText value="#{item.amount}">
                                    <f:convertNumber type="currency" currencySymbol="€" maxFractionDigits="2"/>
                                </h:outputText>
                            </p:column>
                            <p:column>
                                <f:facet name="header">Pro/Privé</f:facet>
                                <h:outputText value="#{100 - item.privatePart}">
                                    <f:convertNumber type="currency" maxFractionDigits="0" currencySymbol=""/>
                                </h:outputText>
                                /
                                <h:outputText value="#{item.privatePart}">
                                    <f:convertNumber type="currency" maxFractionDigits="0" currencySymbol="%"/>
                                </h:outputText>
                            </p:column>
                            <p:column>
                                <f:facet name="header">% déductabilité</f:facet>
                                <h:outputText value="#{item.taxDeductible}">
                                    <f:convertNumber type="currency" maxFractionDigits="2" currencySymbol="%"/>
                                </h:outputText>
                            </p:column>
                            <p:column>
                                <f:facet name="header">Montant déduit</f:facet>
                                <h:outputText value="#{chargeDetailView.calculate_deductible_amount(item)}">
                                    <f:convertNumber type="currency" maxFractionDigits="2" currencySymbol="€"/>
                                </h:outputText>
                            </p:column>
                            <p:column style="text-align: right">
                                <f:facet name="header">Action <i class="fas fa-cog"></i></f:facet>
                                <p:splitButton id="action_split" value=" Modifier" icon="far fa-edit" style="font-size: 10px">
                                    <p:menuitem value=" Supprimer" icon="fas fa-trash-alt" style="font-size: 10px"/>
                                </p:splitButton>
                            </p:column>
                            <p:columnGroup type="footer">
                                <p:row>
                                    <p:column colspan="6" rowspan="3" style="background: #f4f8fb; border: none; border-right: 15px solid white;" />
                                    <p:column colspan="2" footerText="Total de la depense" style="text-align: left;  border: none; background-color: #00b1ff; color: white;  font-weight: 600; font-size: 15px"/>
                                    <p:column footerText="#{chargeDetailView.convert_double_in_string(chargeDetailView.charge.amount)} €"  style="text-align: right;  border: none; background-color: #00b1ff; color: white; font-weight: 600; font-size: 15px"/>
                                </p:row>
                                <p:row>
                                    <p:column colspan="2" footerText="Montant déjà imputé" style="text-align: left;  border: none; font-size: 12px; padding-left: 18px;"/>
                                    <p:column footerText="#{chargeDetailView.convert_double_in_string(chargeDetailView.imputedAmount)} €" style="text-align: right;  border: none; font-size: 12px; padding-right: 19px;"/>
                                </p:row>
                                <p:row>
                                    <p:column colspan="2" footerText="Montant déduit" style="text-align: left;  border: none; background-color: #81c868; color: white; font-size: 12px; padding-left: 18px;"/>
                                    <p:column footerText="#{chargeDetailView.convert_double_in_string(chargeDetailView.total_deductible_amount)} €" style="text-align: right;  border: none; background-color: #81c868; color: white; font-size: 12px; padding-right: 19px;"/>
                                </p:row>
                            </p:columnGroup>
                        </p:dataTable>
                    </p:panel>
                </div>
            </div>

        </h:form>

        <!-- CHARGE EDIT MODAL -->
        <p:dialog header="Modifier un frais" widgetVar="chargeEdit-modal" modal="true"
                  responsive="true" width="600" draggable="false" closable="false"
                  focus="chargeEdit-modal-close-btn" blockScroll="true">
            <h:form id="chargeEdit-modal-form">
                <div class="ui-fluid p-formgrid p-grid">
                    <div class="p-field p-col-12 p-md-12">
                        <p:outputLabel for="charge-label" value="Description"/>
                        <p:inputText id="charge-label" value="#{chargeDetailView.charge.label}"/>
                    </div>
                </div>
                <div class="ui-fluid p-formgrid p-grid">
                    <div class="p-field p-col-6 p-md-6">
                        <p:outputLabel for="journal" value="Journal"/>
                        <p:selectOneMenu id="journal" disabled="true">
                            <f:selectItem itemLabel="Select One" itemValue="" />
                            <f:selectItem itemLabel="Xbox One" itemValue="Xbox One" />
                            <f:selectItem itemLabel="PS4" itemValue="PS4" />
                            <f:selectItem itemLabel="Wii U" itemValue="Wii U" />
                        </p:selectOneMenu>
                    </div>
                    <div class="p-field p-col-6 p-md-6">
                        <p:outputLabel for="supplier" value="Fournisseurs"/>
                        <p:autoComplete id="supplier" value="#{chargeDetailView.charge.userSupplier}" completeMethod="#{chargeListView.completeSupplier}"
                                        dropdown="true" var="userSupplier" itemLabel="#{userSupplier.supplier.label}" itemValue="#{userSupplier}" minQueryLength="2"/>
                    </div>
                </div>
                <div class="ui-fluid p-formgrid p-grid">
                    <div class="p-field p-col-6 p-md-6">
                        <p:outputLabel for="createdAt" value="Date de facturation"/>
                        <p:datePicker id="createdAt" value="#{chargeDetailView.charge.createdAt}" />
                    </div>
                    <div class="p-field p-col-6 p-md-6">
                        <p:outputLabel for="dueAt" value="Date limite de paiement"/>
                        <p:datePicker id="dueAt" value="#{chargeDetailView.charge.dueAt}" />
                    </div>
                </div>
                <div class="ui-fluid p-formgrid p-grid">
                    <div class="p-field p-col-6 p-md-6">
                        <p:outputLabel for="amount" value="Montant total TTC"/>
                        <p:inputNumber id="amount" value="#{chargeDetailView.charge.amount}" symbol=" €" symbolPosition="s"
                                       decimalSeparator="," thousandSeparator=" ">
                        </p:inputNumber>
                    </div>
                    <div class="p-field p-col-6 p-md-6">
                        <p:outputLabel for="status" value="Statut de paiement"/>
                        <p:selectOneMenu id="status">
                            <p:importEnum type="com.projet.enumeration.ChargeStatus" var="ChargeStatus" allSuffix="VALUES"/>
                            <f:selectItems var="status" value="#{ChargeStatus.VALUES}" itemLabel="#{status.status}" itemValue="#{status}" />
                        </p:selectOneMenu>
                    </div>
                </div>
                <div class="ui-fluid p-formgrid p-grid">
                    <div class="p-field p-col-6 p-md-6">
                        <p:outputLabel for="freeCom" value="Communication libre"/>
                        <p:inputText id="freeCom" placeholder="Ex: facture 344421" disabled="true"/>
                    </div>
                    <div class="p-field p-col-6 p-md-6">
                        <p:outputLabel for="structuredCom" value="Communication structurée"/>
                        <p:inputMask id="structuredCom" placeholder="+++XXX/XXXX/XXXXX+++" mask="+++999/9999/99999+++"
                                     disabled="true"/>
                    </div>
                </div>
            </h:form>
            <f:facet name="footer">
                <p:commandButton id="chargeEdit-modal-close-btn" form="chargeEdit-modal-form" type="button" value="Fermer"
                                 styleClass="secondary-button" onclick="PF('chargeEdit-modal').hide()"
                                 update=":chargeDetailForm:msgs, :chargeDetailForm:config-card, :chargeDetailForm:detail-card"/>
                <p:commandButton form="chargeEdit-modal-form" value="Modfier" styleClass="success-btn"
                                 icon="fa fa-check" onclick="PF('chargeEdit-modal').hide()"
                                 update=":chargeDetailForm:msgs"/>
            </f:facet>
        </p:dialog>



        <!-- ITEM EDIT MODAL -->
        <p:dialog header="Modifier un frais" widgetVar="itemEdit-modal" modal="true"
                  responsive="true" width="600" draggable="false" closable="false"
                  focus="itemEdit-modal-close-btn" blockScroll="true">
            <h:form id="itemEdit-modal-form">
                <div class="ui-fluid p-formgrid p-grid">
                    <div class="p-field p-col-12 p-md-12">
                        <p:outputLabel for="item-description" value="Description"/>
                        <p:inputText id="item-description" value="#{chargeDetailView.accountItem.description}"/>
                    </div>
                </div>
                <div class="ui-fluid p-formgrid p-grid">
                    <div class="p-field p-col-12 p-md-12">
                        <p:outputLabel for="item-financialAccount" value="Journal"/>
                        <p:autoComplete id="item-financialAccount" value="#{chargeDetailView.accountItem.userAccount}" completeMethod="#{chargeDetailView.searchUserAccount}"
                                        var="userAccount" itemLabel="#{chargeDetailView.display_detailed_userAccount_label(userAccount)}" itemValue="#{userAccount}"
                                        converter="userAccountConverter" forceSelection="true" dropdown="true" minQueryLength="2" scrollHeight="250"
                                        groupBy="#{userAccount.financialAccount.accountCategory.label}">
                            <p:ajax event="itemSelect" listener="#{chargeDetailView.on_selected_userAccount}" update="item-deductible, item-privatePart, deductible-amount" process="@this"/>
                        </p:autoComplete>
                    </div>
                </div>
                <div class="ui-fluid p-formgrid p-grid">
                    <div class="p-field p-col-6 p-md-6">
                        <p:outputLabel for="item-amount" value="Montant à imputer (en €)"/>
                        <p:inputNumber id="item-amount" value="#{chargeDetailView.accountItem.amount}" decimalSeparator="," thousandSeparator=" ">
                            <p:ajax update="deductible-amount" listener="#{chargeDetailView.accountItem_amount_is_set()}" process="@this"/>
                        </p:inputNumber>
                    </div>
                    <div class="p-field p-col-6 p-md-6">
                        <p:outputLabel for="item-deductible" value="% de déductabilité"/>
                        <p:inputNumber id="item-deductible" value="#{chargeDetailView.accountItem.taxDeductible}" placeholder="ex: 75(%)">
                            <p:ajax update="deductible-amount" listener="#{chargeDetailView.accountItem_taxDeductible_is_set()}" process="@this"/>
                        </p:inputNumber>
                    </div>
                </div>
                <div class="ui-fluid p-formgrid p-grid">
                    <div class="p-field p-col-6 p-md-6">
                        <p:outputLabel for="item-privatePart" value="% Quote-part privée"/>
                        <p:inputNumber id="item-privatePart" value="#{chargeDetailView.accountItem.privatePart}" placeholder="ex: 10(%)">
                            <p:ajax update="deductible-amount" listener="#{chargeDetailView.accountItem_privatePart_is_set()}" process="@this"/>
                        </p:inputNumber>
                    </div>
                    <div class="p-field p-col-6 p-md-6">
                        <p:outputLabel for="deductible-amount" value="Montant déduit (simulation en €)"/>
                        <p:inputText id="deductible-amount" value="#{chargeDetailView.simulate_deductible_amount()}" disabled="true" />
                    </div>
                </div>
            </h:form>
            <f:facet name="footer">
                <p:commandButton id="itemEdit-modal-close-btn" form="itemEdit-modal-form" type="reset" value="Fermer"
                                 styleClass="secondary-button" onclick="PF('itemEdit-modal').hide()"
                                 update="itemEdit-modal-form"/>
                <p:commandButton form="itemEdit-modal-form" value="Modfier" styleClass="success-btn"
                                 icon="fa fa-check" onclick="PF('itemEdit-modal').hide()"
                                 update=":chargeDetailForm:itemList" action="#{chargeDetailView.addAccountItem}"/>
            </f:facet>
        </p:dialog>

    </ui:define>

</ui:composition>